/*
 * us.c
 *
 *  Created on: 18 Oct 2023
 *      Author: mariam hany
 */

#include"icu.h"
#include "us.h"
#include"gpio.h"
#include <util/delay.h>


uint8 g_edges=0;
uint16 totale_time=0;

/*************************************************************************************************
                        Private Functions Prototypes
 ************************************************************************************************/
/*description :
 * Send the Trigger pulse to the ultrasonic.
 */
static void Ultrasonic_Trigger(void);
/*************************************************************************************************
 	 	 	 	 	 	 	 function Definitions
*********************************************************************************************** */
/* description :
 1. Initialize the ICU driver as required.
 2. Setup the ICU call back function.
3. Setup the direction for the trigger pin as output pin through the
GPIO driver
 */
void Ultrasonic_init(void){
	/* call the init fn of the ICU by passing it an object of the configuration  */
	extern ICU_ConfigType icu;
	ICU_init(&icu);

	/*set call back fn */
	ICU_setCallBack(Ultrasonic_edgeProcessing);
	/*Setup the direction for the trigger pin as output pin*/
	GPIO_setupPinDirection(TRIGGER_PORT_ID,TRIGGER_PIN_ID,PIN_OUTPUT);
	/* initially set to low */
	GPIO_writePin(TRIGGER_PORT_ID , TRIGGER_PIN_ID , LOGIC_LOW);
	}
/*description :
 * Send the Trigger pulse to the ultrasonic.
 */
static  void Ultrasonic_Trigger(void){
	/*semd a trigger pulse for 10usec */
	GPIO_writePin (TRIGGER_PORT_ID,TRIGGER_PIN_ID,LOGIC_HIGH);
	_delay_us(15);
	GPIO_writePin (TRIGGER_PORT_ID,TRIGGER_PIN_ID,LOGIC_LOW);
}
/*description:
 1. Send the trigger pulse by using Ultrasonic_Trigger function.
 2.Start the measurements by the ICU from this moment.
  	  Return: The measured distance in Centimeter.

 */
uint16 Ultrasonic_readDistance(void){
	uint16 distance=0;
	Ultrasonic_Trigger();
	ICU_clearTimerValue();


	while (g_edges!=2);
	distance =(float)(totale_time/58.8);
	return distance;
}
/*
 *  Description:
1. This is the call back function called by the ICU driver.
2.This is used to calculate the high time (pulse time) generated by
the ultrasonic sensor.
 *
 */
void Ultrasonic_edgeProcessing(void){
	g_edges++;
	/* 1 tick means that the trigger has started and the sensor start sending*/
	if (g_edges==1){
		ICU_clearTimerValue();
		ICU_setEdgeDetectionType(FALLING);
	}
	/* falling is detected means the us has returned back */
	else if(g_edges==2){
		totale_time=ICU_getInputCaptureValue();
		ICU_clearTimerValue();
		ICU_setEdgeDetectionType(RAISING  );
		g_edges=0;
	}
}

